#!/usr/bin/env node
const { program } = require('commander');
const chalk = require('chalk');
const { warn } = require('../lib/log.js')
const { hasLocalChanged, isRemoteBranch, command, gitBranchIs } = require('../lib/utils');

program
  .name('rich')
  .usage('merge <branch-name>')
  .on('--help', () => {
    console.log()
    console.log(chalk.gray('    # merge git\'s branch'))
    console.log('    $ rich merge feature-t1')
    console.log()
  })
  .on('exit', console.log)
  .parse(process.argv)

function help () {
 if (program.args.length < 1) return program.help()
}

help()

let branchName = program.args[0];

async function run () {
  const [isChange, isRemote, currentBranch] = await Promise.all([hasLocalChanged(), isRemoteBranch(branchName), gitBranchIs()])
  // 如果有本地修改，警告
  if (isChange) {
    warn('There are uncommitted codes')
    process.exit(0)
  }
  try {
    // 默认git merge 采用 fast-forward
    await command(`git merge ${branchName} --squash`)
    await command(`git commit -am "Merge branch '${branchName}' into ${currentBranch}"`)
    await command(`git branch -d ${branchName}`)
    if (isRemote) {
      await command(`git push origin -d ${branchName}`)
    }
  } catch (err) {
    //
  }
}

run()