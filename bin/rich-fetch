#!/usr/bin/env node

const { program } = require('commander');
const chalk = require('chalk')
const { queryLocalBranches, command } = require('../lib/utils')
const Log = require('../lib/log')

program
  .name('rich')
  .usage('fetch <branch-type>')
  .on('--help', () => {
    console.log('  Examples:')
    console.log()
    console.log(chalk.gray('    # synchronize all feature branches'))
    console.log('    $ rich fetch feat')
    console.log()
    console.log(chalk.gray('    # synchronize all hotfix branches'))
    console.log('    $ rich fetch fix')
    console.log()
  })
  .on('exit', console.log)
  .parse(process.argv)

const args = process.argv.slice(2)
const branchType = args[0]

async function main () {
  const branches = (await queryLocalBranches() || [])
    .filter(name => new RegExp(`${branchType}/.+`).test(name))
  let length = branches.length
  while(length && --length) {
    try {
      await command(`git switch ${branches[length]}`)
      await command(`git rebase master`)
    } catch (err) {
      Log.error('Code conflict, please resolve it manually')
      process.exit(0)
    }
  }
  Log.success('Sync succeeded')
}

main()