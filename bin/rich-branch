#!/usr/bin/env node
const { program } = require('commander');
const chalk = require('chalk');
const { branchType } = require('../lib/questions')
const { 
  command, 
  askQuestions, 
  hasLocalChanged, 
  oraPromise, 
  gitBranchIs, 
  isRemoteBranch, 
  exec 
} = require('../lib/utils.js')

program
  .name('rich')
  .usage('branch <branch-name>')
  .option('-d, --delete',  'delete branch')
  .option('-b, --branch',  'create branch and switch')
  .option('-desc, --description', 'create branch description')
  .option('-s, --search',  'search branch')
  .on('--help', () => {
    console.log('  Examples:')
    console.log()
    console.log(chalk.gray('    # create git\'s new branch'))
    console.log('    $ rich branch f1')
    console.log()
    console.log(chalk.gray('    # search git\'s branch'))
    console.log('    $ rich branch -s feat')
    console.log()
    console.log(chalk.gray('    # delete git\'s branch'))
    console.log('    $ rich branch -d f1')
    console.log()
  })
  .on('exit', console.log)
  .parse(process.argv)

const options = program.opts();  // 定义的option

let branchName = program.args[0]; // 分支名称
let description =  program.args[1]

/**
 * @description 创建新分支
 * @param { branchName: string } 分支名称
 */
async function createBranch (branchName) {
  const answer = await askQuestions([branchType]);
  let newBranchName = `${answer.type}/${branchName}`;
  let stack = [command(`git checkout ${options.branch ? '-b' : ''} ${newBranchName}`)]
  if (options.description) {
    stack.push(setBranchDescription(newBranchName, description))
  }
  return Promise.all(stack).then(() => newBranchName).catch(() => { throw newBranchName });
}

/**
 * @description 删除分支
 * @param { branchName: string } 分支名称
 */
async function deleteBranch () {
  const str = program.args.reduce((str, name, index) => str += `${index > 0 ? '|' : ''}${name}`, '')
  return command(`git branch -a | grep -E '${str}' | xargs git branch -D`)
    .catch(() => {
      console.log(chalk.red(`Failed to delete. There is no branch named '${str}'`))
    })
}

/**
 * @description 为分支设置备注
 * @param {string} branchName 分支名称
 * @param {string} description 备注
 * @returns 
 */
function setBranchDescription (branchName, description) {
  console.log(`git config branch.${branchName}.description "${description}"`)
  return command(`git config branch.${branchName}.description "${description}"`)
}

/**
 * @description 通过分支名获取备注
 * @param {string} 分支名
 */
async function getDescriptionByBranch (branch) {
  const branchName = /(?!(\*|\s)).+/.exec(branch)[0]
  const description = await command(`git config branch.${branchName}.description`).catch(() => '')
  return description ? `${branch}: ${description}` : branch
}

/**
 * @description 暂存本地修改
 */
async function stashCode () {
  // 本地是否有修改，如果有则暂存
  if (await hasLocalChanged()) {
    console.log(chalk.green('本地有修改但未提交的文件, 已为你进行本地暂存'))
    await oraPromise(async () => {
      await command('rm -rf .git/index.lock')
      await command('git add .')
      await command(`git stash push -m "rich-flow stash your code at ${new Date().toLocaleString()}"`)
    }, {text: '暂存代码'})
  }
}

/**
 * @description 拉取最新代码
 */
async function pullCode () {
  const currentBranchName = await gitBranchIs()
  if (await isRemoteBranch(currentBranchName)) {
    await command('git pull')
  }
}

function searchWithDescription (keyword = '') {
  return exec(`git branch | grep '${keyword}'`)
    .then(async res => {
      const str = res.stdout.trim()
      const branches = str.split(/(?:\n|$)(?:\s)*/)
      if (branches.length === 1 && options.description) {
        await setBranchDescription(branches[0], description)
      }
      const stack = branches.reduce((list, name) => [...list, getDescriptionByBranch(name)], [])

      Promise.all(stack).then(res => {
        res.forEach(t => { 
          if (t.indexOf('*') !== -1) {
            console.log(chalk.green(t))
          } else {
            console.log(`  ${t}`)
          }
         })
      })

    }).catch(() => {
      console.log(chalk.red('Unmatched'))
    })
}

/**
 * @description 删除分支
 * @param branchName 分支名称
 * @returns 
 */
async function onDelete (branchName) {
  await stashCode()
  await pullCode()
  if (!options.delete) return 'next'
  return deleteBranch(branchName)
}

/**
 * @description 创建分支
 * @param branchName 分支名称
 * @returns 
 */
 function onCreate (branchName) {
  if (!options.branch) return 'next'
  return createBranch(branchName)
    .then((newBranchName) => {
      console.log(`A branch named '${chalk.green(newBranchName)}' has been created for you`)
    })
    .catch((newBranchName) => {
      console.log(chalk.red(`Failed to create. A branch named '${newBranchName}' already exists`))
    })
}

/**
 * @description 分支模糊搜索
 * @param keyword 分支关键字
 * @returns 
 */
function onSearch (keyword='') {
  if (!options.search) return 'next'
  return searchWithDescription(keyword)
}


function onBranch () {
  return searchWithDescription()
}

/**
 * @description 分支操作责任链链
 * @param branchName 分支名称
 * @param handlers 
 */
async function chain (branchName, handlers) {
  let index = -1
  while(++index < handlers.length) {
    if (await handlers[index](branchName) !== 'next') {
      break
    }
  }
}

async function main () {
  await chain(branchName, [onDelete, onSearch, onCreate, onBranch])
}

main()