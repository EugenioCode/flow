#!/usr/bin/env node
const { program } = require('commander');
const { command, stat, readFile, writeFile, oraPromise } = require('../lib/utils')
const Logger = require('../lib/log')
const chalk = require('chalk')
const path = require('path')

program
  .name('rich')
  .usage('ignore <filename>')
  .on('--help', () => {
    console.log('  例如:')
    console.log()
    console.log(chalk.gray('    # 忽略指定文件'))
    console.log('    $ rich ignore .DS_Store')
    console.log()
  })
  .on('exit', console.log)
  .parse(process.argv)

function help () {
  if (process.argv.length < 1 ) return program.help();
}

help()

const fileName = process.argv[2]

async function addGitignore () {
  const rootPath = path.resolve(process.cwd(), '.gitignore')
  const fileGlob = `*/${fileName}`
  if (await stat('.gitignore')) {               // 有.gitignore文件
    const content = await readFile(rootPath)
    if (content.indexOf(fileGlob) === -1) {     // fileGlob 是否已存在
      writeFile(rootPath, content + '\n' + fileGlob)
    }
  } else {
    writeFile(rootPath, fileGlob)
  }
}

async function main () {
  if (await stat('.git')) {
    return oraPromise(() => Promise.all([ addGitignore(), command(`git rm -r -n ${fileName} -f --ignore-unmatch`)]
      .map(t => t.catch(console.log))),
      { text: `设置忽略文件` }
    )
  }
  Logger.error('未初始化 git')
}

main()